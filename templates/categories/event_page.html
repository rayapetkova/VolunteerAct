{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Page</title>
    <link rel="stylesheet" href="{% static 'css/base/nav_bar.css' %}">
    <link rel="stylesheet" href="{% static 'css/base/footer.css' %}">
    <link rel="stylesheet" href="{% static 'css/categories/event_page.css' %}">
</head>
<body>

{% include 'base/nav_bar.html' %}

<main>
    <section class="upper-section">
        <h2>{{ object.title }}</h2>

        <div class="host">
            <a href="{% url 'profile-details-update' pk=object.host.profile.id %}" class="img-container">
                <img src="{{ object.host.profile.profile_image.url }}" alt="host-img">
            </a>

            <div class="more-info">
                <p>Hosted By</p>
                {% if request.user.profile.id == object.host.profile.id %}
                    <a href="{% url 'profile-details-update' pk=object.host.profile.id %}" class="host-name">You</a>
                {% else %}
                    <a href="{% url 'profile-details-update' pk=object.host.profile.id %}"
                       class="host-name">{{ object.host.profile.full_name }}</a>
                {% endif %}

            </div>
        </div>
    </section>

    <section class="info-section">
        <div class="left">
            {% if object.host.id == request.user.id and not object.passed_event %}
                <div>
                    <div class="buttons-container-edit-delete">
                        <a href="{% url 'edit-event' categoryId=object.category.id pk=object.id %}" class="edit-btn">Edit Event</a>
                        <a href="#" class="delete-btn">Delete Event</a>
                    </div>
                </div>
            {% elif object.host.id != request.user.id and not object.passed_event %}
                <div>
                    <div class="buttons-container-edit-delete">
                        {% if request.user.is_authenticated %}
                            {% if not user_favourite_event %}
                                <a class="save-to-favs-btn">Save Event to Favourites<img src="{% static 'images/star_icon.png' %}" alt="star-icon"></a>
                            {% else %}
                                <a class="save-to-favs-btn saved-to-favs">Saved Event to Favourites<img src="{% static 'images/done_icon.png' %}" alt="star-icon"></a>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            {% else %}
                <p class="already-passed-event">This event has passed! Click here to see more: <a href="#explore">See more</a></p>
            {% endif %}

            <div class="event-img-container">
                <img src="{{ object.poster_image.url }}" alt="event_image">
            </div>

            <h4>Details</h4>

            <div class="text-info">
                <p>{{ object.details }}</p>
            </div>

            <div class="keywords-container">
                {% for keyword in keywords %}
                    <p>{{ keyword }}</p>
                {% endfor %}
            </div>

            <div class="comments-container">
                <div class="title-container">
                    <h3 id="comments-count">Comments ({{ count_comments }})</h3>

                    {% if event_comments %}
                        <a href="{% url 'all-events-page' %}">See all comments</a>
                    {% endif %}
                </div>

                <div class="all-comments">

                    {% for comment in event_comments %}
                        <div class="comment-container">
                            <div class="author">
                                <a href="{% url 'profile-details-update' pk=comment.user.profile.id %}" class="img-container">
                                    <img src="{{ comment.user.profile.profile_image.url }}" alt="host-img">
                                </a>

                                <div class="more-info">
                                    {% if request.user.id == comment.user.id %}
                                        <a href="{% url 'profile-details-update' pk=comment.user.profile.id %}" class="host-name">You</a>
                                    {% else %}
                                        <a href="{% url 'profile-details-update' pk=object.host.profile.id %}"
                                           class="host-name">{{ comment.user.profile.full_name }}</a>
                                    {% endif %}

                                </div>
                            </div>

                            <p>{{ comment.body }}</p>
                        </div>
                    {% empty %}
                        <div class="first-one">
                            <p class="first-to-comment-message">Be the first one to comment!</p>

                            {% if not request.user.is_authenticated %}
                                <a href="{% url 'login-user' %}" class="login-btn">Log In</a>
                            {% endif %}
                        </div>

                    {% endfor %}

                    {% if request.user.is_authenticated %}
                        <div class="send-comment-container">
                            <input type="text" id="add-new-comment" name="add-new-comment" placeholder="Add new comment..." >
                            <img src="{% static 'images/send_icon.png' %}" class="send-comment" alt="send-icon">
                        </div>
                    {% endif %}

                </div>
            </div>
        </div>

        <div class="right {% if request.user in object.attendees.all %}attending{% endif %}">
            <div class="event-category">
                <div class="title-and-see-all">
                    <h4>Category</h4>
                </div>

                <a href="{% url 'category-page' pk=object.category.id %}"><img src="{{ object.category.image.url }}" alt="category-img">{{ object.category.name }}</a>
            </div>

            <div class="location-container">
                <div class="title-and-see-all">
                    <h4>More info</h4>
                </div>

                <section class="box">
                    <img src="{% static 'images/clock.png' %}" alt="clock_icon">
                    <p>{{ object.time }}</p>
                </section>

                <section class="box">
                    <img src="{% static 'images/location_grey.png' %}" alt="location_grey_icon">
                    <p>{{ object.exact_location }}</p>
                </section>
                <iframe src="https://www.google.com/maps?q={{ object.exact_location }}&output=embed&maptype=satellite"></iframe>
            </div>

            {% if request.user in object.attendees.all %}
                <p class="you-are-attending-message">You are attending this event!</p>
            {% endif %}

            <div class="buttons-container-attend">
                {% if request.user.is_authenticated and not event.host == request.user %}
                    {% if request.user in object.attendees.all %}
                        <button class="cancel-attendance">Cancel attendance</button>
                    {% else %}
                        <button class="attend">Attend</button>
                    {% endif %}
                {% endif %}

                <button class="share">Share <img src="{% static 'images/share.png' %}" alt="share-icon"></button>
            </div>
        </div>
    </section>

    {% if see_more_events %}
        <section class="upcoming-events" id="explore">
            <div class="title-container">
                <h3>See more ({{ count_more_events }})</h3>
                <a href="{% url 'all-events-page' %}">See all events</a>
            </div>

            <div class="events">
                {% for event in see_more_events %}
                    <a href="{% url 'event-page' categoryId=event.category.id pk=event.id %}" class="event-container">
                        <div class="img-container">
                            <img src="{{ event.poster_image.url }}" alt="event-img">
                        </div>

                        <div class="info">
                            <h6>{{ event.title }}</h6>

                            {% if event.host.id == request.user.id %}
                                <div class="your-event-container">
                                    <p>Your event</p>
                                    <img src="{% static 'images/your_event_icon.png' %}" alt="your-event-icon" >
                                </div>
                            {% endif %}

                            <p>Hosted by: {{ event.host.profile.full_name }}</p>
                            <p>{{ event.time }}</p>
                        </div>
                    </a>
                {% endfor %}
            </div>
        </section>
    {% endif %}
</main>

<div class="attending-cont">
    <div class="going-to-event-container">
        <h3>You are going!</h3>

        <section>
            <div class="left-img-container">
                <img src="{{ object.poster_image.url }}" alt="event-img">
            </div>

            <div class="right">
                <h5>{{ object.title }}</h5>

                <section class="box">
                    <img src="{% static 'images/clock.png' %}" alt="clock_icon">
                    <p>{{ object.time }}</p>
                </section>

                <section class="box">
                    <img src="{% static 'images/location_grey.png' %}" alt="location_grey_icon">
                    <p>{{ object.exact_location }}</p>
                </section>

                <section class="box">
                    <p class="reminder-message">You will receive a reminder email 1 day before the event!</p>
                </section>

                <button class="cancel">Cancel attending</button>
                <button class="share">Share <img src="{% static 'images/share_white.png' %}" alt="share-img"></button>
            </div>
        </section>
    </div>
</div>

<div class="cancel-attendance-cont">
    <div class="going-to-event-container">
        <h3>Are you sure you want to cancel your attendance?</h3>

        <section>
            <div class="left-img-container">
                <img src="{{ object.poster_image.url }}" alt="event-img">
            </div>

            <div class="right">
                <h5>{{ object.title }}</h5>

                <section class="box">
                    <img src="{% static 'images/clock.png' %}" alt="clock_icon">
                    <p>{{ object.time }}</p>
                </section>

                <section class="box">
                    <img src="{% static 'images/location_grey.png' %}" alt="location_grey_icon">
                    <p>{{ object.exact_location }}</p>
                </section>

                <button class="cancel">Yes, cancel my attendance!</button>
                <button class="share">Share <img src="{% static 'images/share_white.png' %}" alt="share-img"></button>
            </div>
        </section>
    </div>
</div>

<div class="delete-event-cont">
    <form method="POST">
        {% csrf_token %}

        <h3>Are you sure you want to delete this event?</h3>

        <section>
            <div class="left-img-container">
                <img src="{{ object.poster_image.url }}" alt="event-img">
            </div>

            <div class="right">
                <h5>{{ object.title }}</h5>

                <section class="box">
                    <img src="{% static 'images/clock.png' %}" alt="clock_icon">
                    <p>{{ object.time }}</p>
                </section>

                <section class="box">
                    <img src="{% static 'images/location_grey.png' %}" alt="location_grey_icon">
                    <p>{{ object.exact_location }}</p>
                </section>

                <button type="submit" class="delete-event-btn">Confirm</button>
                <button type="button" class="cancel-deleting-btn">Cancel</button>
            </div>
        </section>
    </form>
</div>

{% include 'base/footer.html' %}

</body>
<script>
    const headerElement = document.getElementsByTagName('header')[0]
    const searchInput = document.getElementsByTagName('input')[0]

    document.addEventListener('scroll', () => {
        if (window.scrollY > 10) {
            headerElement.style.backgroundColor = 'rgba(67, 79, 98, 0.76)'
            searchInput.className += ' white-placeholder'
        } else {
            headerElement.style.backgroundColor = 'transparent'
            searchInput.className = 'search-bar'
        }
    })


    const attendEventBtn = document.getElementsByClassName('attend')[0]
    const attendingEventContainer = document.querySelectorAll('.attending-cont .going-to-event-container')[0]
    const mainElement = document.getElementsByTagName('main')[0]

    if (attendEventBtn) {
        attendEventBtn.addEventListener('click', () => {
            attendingEventContainer.style.display = 'flex'
            mainElement.style.opacity = '0.4'
            mainElement.style.filter = 'alpha(opacity=20)'
        })
    }





    const cancelAttendanceBtn = document.getElementsByClassName('cancel-attendance')[0]
    const cancelAttendanceContainer = document.querySelectorAll('.cancel-attendance-cont .going-to-event-container')[0]

    if (cancelAttendanceBtn) {
        cancelAttendanceBtn.addEventListener('click', () => {
            cancelAttendanceContainer.style.display = 'flex'
            mainElement.style.opacity = '0.4'
            mainElement.style.filter = 'alpha(opacity=20)'
        })
    }


    const cancelAttendance = document.querySelector('.cancel-attendance-cont .cancel')
    const eventUpdateURL = `{% url 'update-event-api' pk='0' %}`.replace('0', {{ object.id }})
    const currentLoggedInUserId = `{{ request.user.id }}`

    if (cancelAttendance) {

        cancelAttendance.addEventListener('click', () => {
            let attendees = []

            const response = fetch(eventUpdateURL)
                .then((response) => response.json())
                .then((resultEvent) => {
                    attendees = resultEvent.attendees.filter(attendee => `${attendee}` !== currentLoggedInUserId)

                    const updateResponse = fetch(eventUpdateURL, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': `{{ csrf_token }}`
                        },
                        body: JSON.stringify({
                            ...resultEvent,
                            attendees
                        })
                    })

                })

            location.reload()
        })

    }





    const deleteEventBtn = document.getElementsByClassName('delete-btn')[0]
    const deleteEventContainerForm = document.querySelectorAll('.delete-event-cont form')[0]

    if (deleteEventBtn) {
        deleteEventBtn.addEventListener('click', () => {
            deleteEventContainerForm.style.display = 'flex'
            mainElement.style.opacity = '0.4'
            mainElement.style.filter = 'alpha(opacity=20)'
        })

        const cancelDeletingBtn = document.getElementsByClassName('cancel-deleting-btn')[0]

        cancelDeletingBtn.addEventListener('click', () => {
            deleteEventContainerForm.style.display = 'none'
            mainElement.style.opacity = '1'
            mainElement.style.filter = 'alpha(opacity=100)'
        })
    }








    const saveToFavsEventBtn = document.getElementsByClassName('save-to-favs-btn')[0]

    if (saveToFavsEventBtn) {
        saveToFavsEventBtn.addEventListener('click', () => {

            const saveToFavsRequest = async() => {
                const response = fetch('{% url 'list-create-favourites-record-api' %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': `{{ csrf_token }}`
                    },
                    body: JSON.stringify({
                        user: `{{ request.user.id }}`,
                        event: `{{ object.id }}`
                    })
                })
                    .then((response) => response.json())
                    .then((result) => {
                        const imgElement = document.createElement('img')
                        imgElement.src = `{% static 'images/done_icon.png' %}`

                        saveToFavsEventBtn.textContent = 'Saved Event to Favourites'
                        saveToFavsEventBtn.appendChild(imgElement)

                        saveToFavsEventBtn.addEventListener('mouseover', () => {
                            saveToFavsEventBtn.style.backgroundColor = 'rgba(53, 191, 237, 0.18)'
                            saveToFavsEventBtn.style.cursor = 'auto'
                        })
                    })
            }

            saveToFavsRequest()
        })
    }









    const sendCommentElement = document.getElementsByClassName('send-comment')[0]
    const addNewCommentInput = document.getElementById('add-new-comment')
    const commentsContainer = document.getElementsByClassName('all-comments')[0]
    const commentsCountElement = document.getElementById('comments-count')
    const allCommentContainers = document.getElementsByClassName('comment-container')

    if (sendCommentElement) {
        sendCommentElement.addEventListener('click', () => {

            const addNewCommentRequest = async() => {
                const response = fetch('{% url 'list-create-comments-api' %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': `{{ csrf_token }}`
                    },
                    body: JSON.stringify({
                        body: addNewCommentInput.value,
                        event: `{{ object.id }}`,
                        user: `{{ request.user.id }}`,
                    })
                })
                    .then((response) => response.json())
                    .then((result) => {
                        addNewCommentInput.value = ''

                        const createdCommentUrl = `{% url 'details-comment-api' pk='0' %}`.replace('0', result.id)

                        const createdCommentWholeDetails = fetch(createdCommentUrl)
                            .then((response2) => response2.json())
                            .then((commentResult) => {

                                const newCommentContainer = document.createElement('div')
                                newCommentContainer.className = 'comment-container'

                                const profileURL = `{% url 'profile-details-update' pk='0' %}`.replace('0', commentResult.user.profile.id)
                                const requestUserId = `{{ request.user.id }}`

                                console.log(commentResult.user.profile)
                                if (requestUserId == `${commentResult.user.id}`) {
                                    newCommentContainer.innerHTML = `
                                        <div class="author">
                                            <a href="${profileURL}" class="img-container">
                                                <img src="${commentResult.profile_image_full_url}" alt="host-img">
                                            </a>

                                            <div class="more-info">
                                                <a href="${profileURL}" class="host-name">You</a>
                                            </div>
                                        </div>

                                        <p>${commentResult.body}</p>
                                    `
                                } else {
                                    newCommentContainer.innerHTML = `
                                        <div class="author">
                                            <a href="${profileURL}" class="img-container">
                                                <img src="${commentResult.profile_image_full_url}" alt="host-img">
                                            </a>

                                            <div class="more-info">
                                                <a href="${profileURL}" class="host-name">${commentResult.user.profile.full_name}</a>
                                            </div>
                                        </div>

                                        <p>${commentResult.body}</p>
                                    `
                                }


                                commentsContainer.prepend(newCommentContainer)

                                if (commentsCountElement.textContent.includes('2')) {
                                    commentsCountElement.textContent = 'Comments (3)'
                                } else if (commentsCountElement.textContent.includes('3')) {
                                    commentsCountElement.textContent = 'Comments (3+)'
                                    commentsContainer.removeChild(allCommentContainers[allCommentContainers.length - 1])
                                }
                            })

                    })
            }

            addNewCommentRequest()

        })
    }





    const attendBtn = document.getElementsByClassName('attend')[0]

    if (attendBtn) {

        attendBtn.addEventListener('click', () => {
            let currentAttendees = []

            const response = fetch(eventUpdateURL)
                .then((response) => response.json())
                .then((resultEvent) => {
                    currentAttendees = resultEvent.attendees
                    currentAttendees.push({{ request.user.id }})

                    const updateResponse = fetch(eventUpdateURL, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': `{{ csrf_token }}`
                        },
                        body: JSON.stringify({
                            ...resultEvent,
                            attendees: currentAttendees
                        })

                    })
                })


        })

    }




</script>
</html>