{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Events Page</title>
    <link rel="icon" type="image/x-icon" href="{% static 'images/just_logo_without_background.png' %}">
    <link rel="stylesheet" href="{% static 'css/base/nav_bar.css' %}">
    <link rel="stylesheet" href="{% static 'css/base/footer.css' %}">
    <link rel="stylesheet" href="{% static 'css/categories/event_comments_page.css' %}">
</head>
<body>
    {% include 'base/nav_bar.html' with logo_color='light'  %}

    <section class="upper-section">
        <img src="{{ event.poster_image.url }}" alt="event-img">

        <div class="emergency-description">
            <h2>{{ event.title }}</h2>

            <div class="emergency-buttons-container">
                <a href="#explore-emergency-events">All Comments</a>
                <a href="{% url 'event-page' categoryId=event.category.id pk=event.id %}" class="add-emergency-event-btn">See more details</a>
            </div>
        </div>

    </section>


    <main id="explore-emergency-events">

        <section class="aside-and-right-content">
            <div class="right">
                <h2 class="all-comments-title-and-count">All Comments ({{ comments|length }})</h2>

                <div class="all-comments-cont">
                    {% for comment in comments %}
                        <div class="comment-container">
                            <div class="author">
                                <a href="{% url 'profile-details-update' pk=comment.user.profile.id %}" class="img-container">
                                    <img src="{{ comment.user.profile.profile_image.url }}" alt="host-img">
                                </a>

                                <div class="more-info">
                                    {% if request.user.id == comment.user.id %}
                                        <a href="{% url 'profile-details-update' pk=comment.user.profile.id %}" class="host-name">You</a>
                                    {% else %}
                                        <a href="{% url 'profile-details-update' pk=event.host.profile.id %}"
                                           class="host-name">{{ comment.user.profile.full_name }}</a>
                                    {% endif %}
                                </div>

                                {% if request.user.id == comment.user.id or request.user.is_staff %}
                                    <div class="editing-icons">
                                        <img src="{% static 'images/edit_icon.png' %}" alt="edit-icon" class="edit-comment-icon {{ comment.id }}">
                                        <img src="{% static 'images/delete_icon.png' %}" alt="delete-icon" class="delete-comment-icon {{ comment.id }}">
                                    </div>
                                {% endif %}
                            </div>

                            <p class="comment-body">{{ comment.body }}</p>
                        </div>
                    {% empty %}
                        <h3>No comments yet</h3>
                    {% endfor %}
                </div>
            </div>
        </section>

    </main>

    {% include 'base/footer.html' %}

</body>

    <script>
        const headerElement = document.getElementsByTagName('header')[0]

        document.addEventListener('scroll', () => {
            if (window.scrollY > 600) {
                headerElement.style.backgroundColor = 'rgba(67, 79, 98, 0.76)'
            } else {
                headerElement.style.backgroundColor = 'transparent'
            }
        })

        function editingComments() {
            const editIconBtns = document.getElementsByClassName('edit-comment-icon')

            for (let editIcon of editIconBtns) {
                const commentId = editIcon.classList[1]
                const commentContainer = editIcon.parentElement.parentElement.parentElement
                const commentBody = editIcon.parentElement.parentElement.parentElement.getElementsByClassName('comment-body')[0]
                const inputEditComment = document.createElement('input')
                inputEditComment.value = commentBody.textContent
                inputEditComment.className = 'edit-comment-input'
                const saveEditedCommentBtn = document.createElement('button')
                saveEditedCommentBtn.textContent = 'Save'
                saveEditedCommentBtn.className = 'save-edited-btn'
                const cancelEditBtn = document.createElement('button')
                cancelEditBtn.textContent = 'Cancel'
                cancelEditBtn.className = 'cancel-edit-btn'

                const buttonsContainer = document.createElement('div')
                buttonsContainer.className = 'comment-buttons-container'
                buttonsContainer.appendChild(saveEditedCommentBtn)
                buttonsContainer.appendChild(cancelEditBtn)

                editIcon.addEventListener('click', () => {
                    const commentBody = editIcon.parentElement.parentElement.parentElement.getElementsByClassName('comment-body')[0]
                    inputEditComment.value = commentBody.textContent

                    commentContainer.removeChild(commentBody)
                    commentContainer.appendChild(inputEditComment)
                    commentContainer.appendChild(buttonsContainer)
                })

                saveEditedCommentBtn.addEventListener('click', () => {
                    const newEditedComment = inputEditComment.value
                    const editCommentUrl = `{% url 'edit-delete-comment-api' pk='0' %}`.replace('0', commentId)

                    fetch(editCommentUrl, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({
                            body: newEditedComment
                        })
                    })
                        .then((response) => response.json())
                        .then((resultEditedComment) => {
                            if (typeof resultEditedComment.body !== 'string') {
                                const ulErrorsEditedComment = document.createElement('ul')
                                ulErrorsEditedComment.className = 'errors-edited-comment'
                                inputEditComment.after(ulErrorsEditedComment)

                                for (let error of resultEditedComment.body) {
                                    if (!ulErrorsEditedComment.textContent.includes(error)) {
                                        const liErrorEl = document.createElement('li')
                                        liErrorEl.textContent = error

                                        ulErrorsEditedComment.appendChild(liErrorEl)
                                    }
                                }
                            } else {
                                commentContainer.removeChild(inputEditComment)
                                commentContainer.removeChild(buttonsContainer)

                                const ulErrors = commentContainer.getElementsByClassName('errors-edited-comment')[0]

                                if (ulErrors) {
                                    ulErrors.remove()
                                }

                                const pCommentBody = document.createElement('p')
                                pCommentBody.className = 'comment-body'
                                pCommentBody.textContent = resultEditedComment.body

                                commentContainer.appendChild(pCommentBody)
                            }

                        })
                })

                cancelEditBtn.addEventListener('click', () => {
                    const pCommentBody = document.createElement('p')
                    pCommentBody.className = 'comment-body'
                    pCommentBody.textContent = commentBody.textContent

                    const ulErrorsEditedComment = commentContainer.getElementsByClassName('errors-edited-comment')[0]
                    if (ulErrorsEditedComment) {
                        ulErrorsEditedComment.remove()
                    }

                    commentContainer.removeChild(inputEditComment)
                    commentContainer.removeChild(buttonsContainer)

                    commentContainer.appendChild(pCommentBody)
                })
            }
        }

        editingComments()




        const sendCommentContainer = document.querySelector('.all-comments .send-comment-container')
        const allCommentsTitleAndCount = document.getElementsByClassName('all-comments-title-and-count')[0]

        function deletingComments() {
            const deleteCommentBtns = document.getElementsByClassName('delete-comment-icon')

            for (let deleteIcon of deleteCommentBtns) {
                const commentId = deleteIcon.classList[1]
                const commentContainer = deleteIcon.parentElement.parentElement.parentElement
                const pConfirmingElement = document.createElement('p')
                pConfirmingElement.className = 'confirm-deleting-comment'
                pConfirmingElement.textContent = 'Are you sure you want to delete this comment?'
                const confirmDeletingCommentBtn = document.createElement('button')
                confirmDeletingCommentBtn.textContent = 'Confirm'
                confirmDeletingCommentBtn.className = 'save-edited-btn'
                const cancelDeletingCommentBtn = document.createElement('button')
                cancelDeletingCommentBtn.textContent = 'Cancel'
                cancelDeletingCommentBtn.className = 'cancel-edit-btn'

                const buttonsContainer = document.createElement('div')
                buttonsContainer.className = 'comment-buttons-container'
                buttonsContainer.appendChild(confirmDeletingCommentBtn)
                buttonsContainer.appendChild(cancelDeletingCommentBtn)

                function handleDeleteIconClick() {
                    const confirmDeletingMessages = commentContainer.getElementsByClassName('confirm-deleting-comment')
                    for (let message of confirmDeletingMessages) {
                        message.remove()
                    }

                    const confirmDeletingBtns = commentContainer.getElementsByClassName('comment-buttons-container')
                    for (let cont of confirmDeletingBtns) {
                        cont.remove()
                    }

                    commentContainer.appendChild(pConfirmingElement)
                    commentContainer.appendChild(buttonsContainer)
                }

                deleteIcon.addEventListener('click', handleDeleteIconClick)

                confirmDeletingCommentBtn.addEventListener('click', () => {
                    const deleteCommentUrl = `{% url 'edit-delete-comment-api' pk='0' %}`.replace('0', commentId)

                    fetch(deleteCommentUrl, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': `{{ csrf_token }}`
                        }
                    })
                        .then((response) => response.json())
                        .then((result) => {
                            commentContainer.remove()
                        })

                })

                cancelDeletingCommentBtn.addEventListener('click', () => {
                    commentContainer.removeChild(pConfirmingElement)
                    commentContainer.removeChild(buttonsContainer)
                })
            }
        }

        deletingComments()

    </script>

</html>